---
title: "Gene Expression EGJA"
author: "Alexis Murillo (for C2PO)"
date: "2025-05-05"
output: 
  html_document:
    toc: true
    toc_float: true
---

<style>
h2 {
  color: #0073e6;
}
</style>

```{r setup, include=FALSE}

#renv::init()
#renv::install(c('dplyr','tidyverse','EnvStats','readxl',
#                'gtsummary',"coin", "rstatix",'cardx','stringr',
#                'tibble','scales','ggplot2','factoextra','dendsort','ComplexHeatmap'))
```

# 1. Calling packages and reading input files

## 1.1. Calling Required Packages


```{r warning=FALSE, message=FALSE}
library(circlize)
library(ComplexHeatmap)
library(dendsort)
library(dplyr)
library(EnvStats)
library(factoextra)
library(ggplot2)
library(gtsummary)
library(readxl)
library(scales)
library(tibble)
library(tidyverse)

```


<br> <br>
```{r }

```
## 1.2. Reading data files

This analysis started with two files. The first one including expression data obtained using the Fluidigm System and the second one including clinical information from these patients. All files can be found in the 'Input files' folder.

```{r }

#Loading expression data
read.csv('Input files/resultados Placa TEG 29_09_23_dXPRESS.csv')->expr_data

expr_data<-expr_data%>%dplyr::filter(!(Name %in% c("PC 8","PC 9","PC 14",   
                                           "PC 22","PC 30","PC 45",
                                           "PC 63","775", "3014"))) #Excluding cases with neoadjuvancy and CECs

#Formatting all expression values as numeric data
as.numeric(expr_data$Value)->expr_data$Value

#Loading clinical data
read_excel("Input files/Database EGJA.xlsx",sheet="R")->clinic_data

#Filtering data with available gene expression
#sort(table(c(unique(expr_data$Name),
#        unique(clinic_data$Name))))


```
<br> <br>
```{r }

```
___
# 2. Clinical Profile

## 2.1. Summary Table

We included **`r nrow(clinic_data)` patients** in this study. Below, we represent the summary statistics.

```{r }

clinic_data%>%
  mutate(Sex=ifelse(Sex==1,"M","F"),
         cTNM=ifelse(cTNM<3,"1+2","3+4"))%>%
  tbl_summary(      
    statistic = list(
      all_continuous() ~ "{mean} ({min}-{max})",
      all_categorical() ~ "{n} / {N} ({p}%)"
    ),
    digits = all_continuous() ~ 2,
    include = c("Age","Sex","cTNM", "OS"),
    by="Localization",
    missing = "no",
    label = list(OS ~ "Overall Survival (months)")
  ) |>
  add_overall() |> 
  add_n() |> # add column with total number of non-missing observations
  add_p() |> # test for a difference between groups
  modify_header(label = "**Variable**") |> # update the column header
  bold_labels() 
```

<br> <br>
```{r }

```
___
# 3. Gene Expression Normalization

## 3.1. Subsetting housekeeping genes and showing expression levels

In this step, we separated data from housekeeping genes in this analysis: A (*ACTB*), B (*B2M*), C(*GAPDH*), D(*GUSB*), E(*HPRT1*), F(*RPLP0*), and G(*TFRC*).
According with an in-parallel analysis ran in [NormFinder](https://www.moma.dk/software/normfinder) through [dXpress app](https://rdcu.be/dpQtN), genes 'A' (*ACTB*) and 'E' (*HPRT1*) were the most relevant to normalize data. In this plot, their combination is shown as 'norm'

```{r message=FALSE, warning=FALSE}
expr_data<-expr_data%>%dplyr::select(-ID)

# Using ggplot2 to generate the boxplot+jitterplot 

p<-expr_data%>%
  subset(Gene %in% c("A","B","C","D","E","F","G"))%>%
  pivot_wider(names_from=Gene,values_from=Value)%>%
  mutate(norm=(A+E)/2)%>% #Selected genes using normfinder
  pivot_longer(!c(Name),names_to="Gene",values_to="Value")%>%
  ggplot(aes(x=Gene,y=Value))+geom_boxplot(outlier.shape = NA)+geom_jitter(size=1,width = .15)+
  theme_bw()+ stat_mean_sd_text(y.pos = 25,size=3.5) 

# Saving this result

png("Results/Housekeeping Profile.png",width = 6200,height = 2500,res=600)
p
dev.off()
```

```{r echo=FALSE }

knitr::include_graphics("Results/Housekeeping Profile.png")

```
<br> <br>
```{r }

```
## 3.2. Normalizing the expression of Target Genes
Herein, we will normalize Ct values using 'A' (*ACTB*) and 'E' (*HPRT1*) genes. 


```{r }
norm_data<-expr_data%>%
  pivot_wider(names_from=Gene,values_from=Value)%>%
  group_by(Name)%>%
  mutate(norm=mean(c(A,E)))%>%
  pivot_longer(!c(Name,norm),names_to="Gene",values_to="Value")%>%
  group_by(Name)%>%
  mutate(Value=norm-Value)%>%
  select(-norm)%>%
  pivot_wider(names_from=Gene,values_from=Value)%>%
  select(-A,-B,-C,-D,-E,-F,-G)

# Setting object as data.frame
data.frame(norm_data)->norm_data
# Configuring Name of samples as rownames
norm_data$Name->rownames(norm_data)

png("Results/heatmap_data_norm.png",width=4000,height = 4000,res=600)
heatmap(as.matrix(norm_data[,-1]))
dev.off()
```
At this moment, we have expression data of  **`r ncol(norm_data[,-1])` genes from  `r nrow(norm_data[,-1])` patients.** Patient 3641 has no expression data with passed QC. Blank cells represent missing values.
<br> 
```{r }

```
```{r echo=FALSE }

knitr::include_graphics("Results/heatmap_data_norm.png")

```


<br> <br>
```{r }

```
___
# 4. Unsupervised Analysis

## 4.1. Removing gene/patients with missing data
Before beginning the unsupervised analysis, we need to reduce the number of missing cases in this dataset. To do this, we initially excluded samples with 20% or more missing cases, then reduced genes or patients with 10% or more missing cases. Finally, we screen the database for genes/patients with complete information.

```{r }
# Excluding genes/patients with over 20% missing data
names(tail(sort(colSums(is.na(norm_data))/nrow(norm_data)),10))->exclude_20
#exclude_20
norm_data_pca<-norm_data%>%
  select(-any_of(exclude_20))
norm_data_pca$Name->rownames(norm_data_pca)
names(tail(sort(colSums(is.na(t(norm_data_pca)))/ncol(norm_data_pca)),3))->exclude_20
#exclude_20
norm_data_pca<-norm_data_pca%>%
  filter(!(Name %in% exclude_20))

# Excluding genes/patients with over 10% missing data
names(tail(sort(colSums(is.na(norm_data_pca))/nrow(norm_data_pca)),5))->exclude_10
#exclude_10
norm_data_pca<-norm_data_pca%>%
  select(-any_of(exclude_10))
norm_data_pca$Name->rownames(norm_data_pca)
colSums(is.na(t(norm_data_pca)))/ncol(norm_data_pca)->exclude_10
#exclude_10
names(exclude_10[which(exclude_10!=0)])->exclude_10
#exclude_10
norm_data_pca<-norm_data_pca%>%
  filter(!(Name %in% exclude_10))
```

At this moment, we have expression data of  **`r ncol(norm_data_pca[,-1])` genes from  `r nrow(norm_data_pca[,-1])` patients.**

List of genes for this analysis: **`r stringr::str_replace_all(paste(colnames(norm_data_pca[, -1]), collapse = ", "), "((?:[^,]+, ){14}[^,]+), ", "\\1\n")`**
```{r }
heatmap(as.matrix(norm_data_pca[,-1]))
```

<br> <br>
```{r }

```
## 4.2. Principal Component Analysis (PCA)
For this part, we seek to eliminate genes with low expression (cutoff: -8) and/or low variability (cutoff: 0.8).

```{r }
# Filtering genes with low expression (-dCT < -8)
expr_filtered <- norm_data_pca[,-1] %>%
  select(where(~ mean(.x, na.rm = TRUE) > -8))
```

After this first filter, we retrieved data of  **`r ncol(expr_filtered)` genes from  `r nrow(expr_filtered)` patients.**
```{r }
# Filtering genes with low variability (sd < 0.8)
expr_filtered <- expr_filtered %>%
  select(where(~ sd(.x, na.rm = TRUE) > 0.8))
```

After this filter, we retrieved data of  **`r ncol(expr_filtered)` genes from  `r nrow(expr_filtered)` patients.**

```{r }
# Scaling data and running PCA
expr_scaled <- scale(expr_filtered)  
pca_result <- prcomp(expr_scaled, center = TRUE, scale. = TRUE)

# Observing components contribution to variance
p<-fviz_eig(pca_result, addlabels = TRUE,ncp = 20) 
```

Herein, we require 10 components to achieve over 70% of the explained variance.

```{r }
p
```

Using these 10 components, we retrieved the top 10 relevant genes.
```{r }
p<-fviz_cos2(pca_result, choice = "var", axes = 1:15,top = 10,
             fill = "lightgray", color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle=45))
p

```
<br>
```{r }

```
**Top 10 relevant genes: `r stringr::str_replace_all(paste0(p$data%>%arrange(desc(cos2))%>%top_n(10)%>%select(name)%>%as.matrix(),collapse=', '), "((?:[^,]+, ){14}[^,]+), ", "\\1\n")`**

After that, we plotted all samples according to their values in the first and second components. We also included clinical information to highlight the localization of these samples using ellipses.

```{r }
# Combining with clinical information
pca_df <- as_tibble(pca_result$x[, 1:2]) %>%
  mutate(Name = norm_data_pca$Name)%>%
  left_join(clinic_data,'Name')

# Visualizing PCA results with 95% confidence interval for ellipses showing groups
ggplot(pca_df, aes(x = PC1, y = PC2, color = Localization, label = Name)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_text(vjust = -1.2, size = 2.5, check_overlap = TRUE) +
  stat_ellipse(type = "norm", level = 0.95, linetype = "dashed") +
  labs(
    title = "PCA based on Gene Expression (-dCt)",
    x = paste0("PC1 (", scales::percent(summary(pca_result)$importance[2, 1]), " var)"),
    y = paste0("PC2 (", scales::percent(summary(pca_result)$importance[2, 2]), " var)")
  ) +
  theme_minimal()
```
<br> <br>
```{r }

```
## 4.3. Heatmap with relevant genes from Unsupervised Analysis

```{r fig.width=10, fig.height=4, fig.fullwidth=TRUE}

top_genes <- p$data %>%
  arrange(desc(cos2)) %>%
  slice_head(n = 10) %>%
  pull(name)

# Crear el dataframe para heatmap
for_heat <- norm_data_pca %>%
  left_join(clinic_data, by = "Name") %>%
  select(Name, Localization, 
         cT,pT,
         all_of(top_genes))

df <- for_heat[,-c(1:4)]
row_dend = dendsort(hclust(dist(t(df))))
col_dend = dendsort(hclust(dist(df),"ward.D"))

ha = HeatmapAnnotation(Localization = as.factor(for_heat[,2]),
                       cT=for_heat[,3],
                       pT=for_heat[,4],
                       col = list( Localization = c("Antrum"="yellow",
                                                    "Body"="red",
                                                    "Siewert I"="blue",
                                                    "Siewert II"="green",
                                                    "Siewert III"="purple",
                                                    " "="grey80"),
                                   cT = colorRamp2(c(min(for_heat[,3], na.rm=TRUE),
                                                     max(for_heat[,3], na.rm=TRUE)),
                                                   c("white", "#018571")),
                                   pT = colorRamp2(c(min(for_heat[,4], na.rm=TRUE),
                                                     max(for_heat[,4], na.rm=TRUE)),
                                                   c("white", "#A6611A"))))


p<-Heatmap(t(scale(df)), 
           name = "Level", #title of legend
           column_title = "Samples", 
           row_title = "Genes",
           column_names_gp=gpar(fontsize=7),
           #row_dend_side = "left", 
           #row_split =factor(clinicos$SIEWERT.Antro.Corpo), 
           #column_dend_side = "bottom",
           #cluster_rows = row_dend, 
           #cluster_columns = col_dend,
           row_km=3,
           column_km=4,
           row_names_gp = gpar(fontsize = 10),
           top_annotation = ha,
           column_labels = c(rep("",nrow(expr_filtered))) #Remove col names
)
p


```
<br> <br>
```{r }

```
## 4.4. Heatmap with relevant genes from Unsupervised Analysis (All samples)

```{r fig.width=10, fig.height=4, fig.fullwidth=TRUE}


# Crear el dataframe para heatmap
for_heat <- norm_data %>%
  left_join(clinic_data, by = "Name") %>%
  select(Name, Localization, 
         cT,pT,
         all_of(top_genes))

df <- for_heat[,-c(1:4)]
row_dend = dendsort(hclust(dist(t(df))))
col_dend = dendsort(hclust(dist(df),"ward.D"))

ha = HeatmapAnnotation(Localization = as.factor(for_heat[,2]),
                       cT=for_heat[,3],
                       pT=for_heat[,4],
                       col = list( Localization = c("Antrum"="yellow",
                                                    "Body"="red",
                                                    "Siewert I"="blue",
                                                    "Siewert II"="green",
                                                    "Siewert III"="purple",
                                                    " "="grey80"),
                                   cT = colorRamp2(c(min(for_heat[,3], na.rm=TRUE),
                                                     max(for_heat[,3], na.rm=TRUE)),
                                                   c("white", "#018571")),
                                   pT = colorRamp2(c(min(for_heat[,4], na.rm=TRUE),
                                                     max(for_heat[,4], na.rm=TRUE)),
                                                   c("white", "#A6611A"))))


p<-Heatmap(t(scale(df)), 
           name = "Level", #title of legend
           column_title = "Samples", 
           row_title = "Genes",
           column_names_gp=gpar(fontsize=7),
           #row_dend_side = "left", 
           #row_split =factor(clinicos$SIEWERT.Antro.Corpo), 
           #column_dend_side = "bottom",
           #cluster_rows = row_dend, 
           #cluster_columns = col_dend,
           #row_km=3,
           #column_km=3,
           row_names_gp = gpar(fontsize = 10),
           top_annotation = ha,
           column_labels = c(rep("",nrow(norm_data))) #Remove col names
)
p


```
<br> <br>
```{r }

```
___
# 5. Session Info 
Saving Session Info and R-env...

```{r, echo=FALSE, warning = FALSE, message=FALSE}
renv::init()
renv::snapshot()
sessioninfo::session_info() |> capture.output() |> writeLines("session-info.txt")

```

